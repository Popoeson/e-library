<!doctype html>
<html lang="en">  
<head>  
<meta charset="utf-8" />  
<meta name="viewport" content="width=device-width,initial-scale=1" />  
<title>E-Library ‚Äî AI Search</title>  

<style>  
  :root {  
    --bg: #f4f6fa;  
    --card: #fff;  
    --muted: #6b7280;  
    --accent: #2563eb;  
    --shadow: rgba(0,0,0,0.08);  
    --radius: 14px;  
    --gap: 16px;  
    --container-width: 900px;  
  }  
  * { box-sizing: border-box; }  
  body, html { margin:0; padding:0; font-family: Inter, sans-serif; background: var(--bg); }  
  .container { max-width: var(--container-width); margin: 0 auto; padding: 24px; }  

  /* ---------------- GOOGLE-STYLE ACCOUNT HEADER ---------------- */
  .topbar {
    width: 100%;
    padding: 14px 24px;
    background: #fff;
    display: flex;
    justify-content: flex-end;
    align-items: center;
    box-shadow: 0 1px 4px rgba(0,0,0,0.08);
    position: sticky;
    top: 0;
    z-index: 20;
  }
  .user-area {
    display: flex;
    align-items: center;
    gap: 12px;
    cursor: pointer;
    position: relative;
  }
  .user-name {
    font-weight: 600;
    font-size: 14px;
    color: #374151;
  }
  .user-photo {
    width: 38px;
    height: 38px;
    border-radius: 50%;
    object-fit: cover;
    border: 2px solid #e5e7eb;
  }

  .dropdown {
    position: absolute;
    top: 55px;
    right: 0;
    width: 180px;
    background: #fff;
    border-radius: 12px;
    box-shadow: 0 4px 16px rgba(0,0,0,0.1);
    display: none;
    flex-direction: column;
    overflow: hidden;
  }
  .dropdown.open { display: flex; }
  .dropdown a {
    padding: 12px 16px;
    text-decoration: none;
    font-size: 14px;
    color: #374151;
    border-bottom: 1px solid #f3f4f6;
    transition: background 0.2s;
  }
  .dropdown a:hover { background: #f3f4f6; }
  .dropdown a:last-child { border-bottom:none; }

  /* ---------------- EXISTING DESIGN BELOW ---------------- */
  .site-header { text-align:center; padding:60px 0 40px 0; }  
  .logo { font-size: 32px; font-weight:700; display:block; }  
  .tagline { color: var(--muted); font-size:16px; margin-top:6px; }  
  .search-box { display:flex; flex-direction:column; align-items:center; gap:12px; margin-top:32px; }  
  .search-input { width:100%; max-width:600px; padding:16px 20px; font-size:18px; border-radius:var(--radius); border:1px solid #d1d5db; box-shadow:0 4px 12px var(--shadow); outline:none; transition: all 0.2s ease; }  
  .search-input:focus { border-color: var(--accent); box-shadow:0 6px 18px rgba(37,99,235,0.2); }  
  .controls { display:flex; gap:12px; margin-top:12px; justify-content:center; align-items:center; }  
  .btn { padding:12px 20px; border-radius:var(--radius); border:none; font-weight:600; cursor:pointer; transition: all 0.2s ease; }  
  .btn.primary { background: var(--accent); color:#fff; box-shadow:0 6px 18px rgba(37,99,235,0.2); }  
  .btn.primary:hover { background:#1d4ed8; }  
  .results-info { text-align:center; color: var(--muted); font-size:14px; margin:24px 0 8px 0; }  
  .ai-summary { background: #e0f2fe; color: #0369a1; padding:16px 20px; border-radius: var(--radius); font-size:14px; margin-bottom:16px; line-height:1.5; cursor:pointer; position: relative; transition: max-height 0.3s ease; }  
  .ai-summary.collapsed { max-height: 60px; overflow: hidden; }  
  .ai-summary::after { content: '‚ñº'; position: absolute; right:16px; bottom:16px; font-size:12px; }  
  .ai-summary.expanded::after { content: '‚ñ≤'; }  
  .breadcrumbs { display:flex; flex-wrap:wrap; gap:8px; font-size:13px; margin-bottom:16px; }  
  .breadcrumbs button { background:#f3f4f6; border:1px solid #d1d5db; border-radius:12px; padding:4px 12px; cursor:pointer; transition:0.2s; }  
  .breadcrumbs button.active, .breadcrumbs button:hover { background: var(--accent); color:#fff; border-color: var(--accent); }  
  .results-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(280px,1fr)); gap:var(--gap); }  
  .card { background: var(--card); border-radius: var(--radius); padding:20px; box-shadow:0 8px 24px var(--shadow); display:flex; flex-direction:column; position: relative; transition: all 0.2s ease; }  
  .card:hover { box-shadow:0 12px 32px rgba(0,0,0,0.12); transform: translateY(-2px); }  
  .card h3 { margin:0 0 8px 0; font-size:16px; }  
  .card p { margin:0 0 12px 0; color:var(--muted); font-size:14px; line-height:1.5; }  
  .meta { display:flex; justify-content:space-between; font-size:12px; color:#9ca3af; }  
  .link-btn { padding:6px 10px; border-radius:8px; border:1px solid #d1d5db; text-decoration:none; color: var(--accent); font-weight:600; transition: all 0.2s ease; }  
  .link-btn:hover { background: var(--accent); color:#fff; }  
  .pdf-badge { position:absolute; top:12px; right:12px; background:#ef4444; color:#fff; font-size:11px; font-weight:700; padding:3px 6px; border-radius:6px; }  
  .skeleton { background:#e5e7eb; border-radius: var(--radius); animation:pulse 1.5s infinite ease-in-out; }  
  @keyframes pulse { 0% { opacity:.6; } 50% { opacity:1; } 100% { opacity:.6; } }  
  .skeleton-card { height:160px; padding:20px; }  
  .pagination { margin-top:30px; display:flex; justify-content:center; gap:12px; }  
  .pagination button { padding:10px 18px; border-radius: var(--radius); border:1px solid #d1d5db; background:#fff; cursor:pointer; }  
  .pagination button:hover { background:#f3f4f6; }  
  footer { text-align:center; margin:40px 0 20px 0; font-size:13px; color: var(--muted); }  
</style>  
</head>  

<body>

<!-- GOOGLE STYLE TOPBAR -->
<div class="topbar">
  <div id="userArea" class="user-area" style="display:none;">
    <span id="displayName" class="user-name"></span>
    <img id="displayPhoto" class="user-photo" />
    <div id="dropdownMenu" class="dropdown">
      <a href="index.html">üè† Home</a>
      <a id="logoutBtn" href="#">üö™ Logout</a>
      <a href="#">‚öô Manage Account</a>
    </div>
  </div>
</div>

<header class="site-header">  
  <div class="container">  
    <span class="logo">üìö eLibrary AI</span>  
    <p class="tagline">Search books, articles & PDFs instantly ‚Äî powered by AI.</p>  
  </div>  
</header>  

<main class="container">  
  <section class="search-box">  
    <input id="searchInput" class="search-input" type="text" placeholder="Search e.g. Computer Engineering digital logic" />  
    <div class="controls">  
      <button id="searchBtn" class="btn primary">Search</button>  
      <label><input id="pdfOnly" type="checkbox" checked /> PDF only</label>  
    </div>  
  </section>   

  <section id="resultsInfo" class="results-info hidden"></section>  
  <section id="aiSummary" class="ai-summary collapsed hidden"></section>  
  <section id="breadcrumbs" class="breadcrumbs hidden"></section>  
  <section id="resultsGrid" class="results-grid"></section>  

  <div id="pagination" class="pagination hidden">  
    <button id="prevBtn">‚óÄ Previous</button>  
    <button id="nextBtn">Next ‚ñ∂</button>  
  </div>  
</main>  

<footer>  
  Built with Brave Search ‚Ä¢ Serpstack ‚Ä¢ Demo  
</footer>

<script>

/* ===== FORCE LOGIN ===== */
(function enforceLogin() {
  const g = localStorage.getItem("elib_user_google");
  const a = localStorage.getItem("elib_user_apple");
  const d = localStorage.getItem("elib_demo_account");

  if (!g && !a && !d) {
    window.location.href = "login.html";
  }
})();

/* ===== LOAD USER ===== */
const userArea = document.getElementById("userArea");
const displayName = document.getElementById("displayName");
const displayPhoto = document.getElementById("displayPhoto");
const dropdown = document.getElementById("dropdownMenu");
const logoutBtn = document.getElementById("logoutBtn");

function loadUser() {
  let name =
    localStorage.getItem("elib_user_name") ||
    localStorage.getItem("elib_demo_name");

  let photo =
    localStorage.getItem("elib_user_photo") ||
    "https://www.gstatic.com/images/branding/product/1x/avatar_circle_blue_512dp.png";

  if (name) {
    displayName.textContent = name;
    displayPhoto.src = photo;
    userArea.style.display = "flex";
  }
}

userArea.onclick = () => dropdown.classList.toggle("open");

logoutBtn.onclick = () => {
  localStorage.removeItem("elib_user_name");
  localStorage.removeItem("elib_user_photo");
  localStorage.removeItem("elib_user_google");
  localStorage.removeItem("elib_user_apple");
  localStorage.removeItem("elib_demo_account");
  localStorage.removeItem("elib_demo_name");

  window.location.href = "login.html";
};

loadUser();

/* ----------------------------------------------------------------
   SEARCH LOGIC
---------------------------------------------------------------- */
const API_BASE = "https://e-library-18tg.onrender.com";
const searchInput = document.getElementById('searchInput');
const searchBtn = document.getElementById('searchBtn');
const pdfOnly = document.getElementById('pdfOnly');
const resultsGrid = document.getElementById('resultsGrid');
const resultsInfo = document.getElementById('resultsInfo');
const aiSummary = document.getElementById('aiSummary');
const breadcrumbs = document.getElementById('breadcrumbs');
const pagination = document.getElementById('pagination');
const prevBtn = document.getElementById('prevBtn');
const nextBtn = document.getElementById('nextBtn');

let CURRENT_RESULTS = [];
let PAGE = 1;
const PAGE_SIZE = 12;
let activeSource = null;

const SOURCE_CATEGORIES = {
  serpstack: "Web",
  brave: "Web",
  googlebooks: "Books",
  openlibrary: "Books",
  internetarchive: "Archives",
  crossref: "Journals",
  arxiv: "Journals",
  oercommons: "Educational",
  unknown: "Other"
};

function cleanHTML(str) {
  const tmp = document.createElement("div");
  tmp.innerHTML = str || "";
  return tmp.textContent || tmp.innerText || "";
}

function showSkeleton() {
  resultsGrid.innerHTML = "";
  for (let i = 0; i < 6; i++) {
    const block = document.createElement("div");
    block.className = "skeleton skeleton-card";
    resultsGrid.appendChild(block);
  }
}

function saveState(q, data) {
  localStorage.setItem("elib_last_query", q);
  localStorage.setItem("elib_last_data", JSON.stringify(data));
}

function loadLastState() {
  const q = localStorage.getItem("elib_last_query");
  const raw = localStorage.getItem("elib_last_data");
  if (!q || !raw) return;

  searchInput.value = q;
  const data = JSON.parse(raw);

  CURRENT_RESULTS = data.results || [];
  PAGE = 1;

  renderResults({ originalQuery: q, summary: data.summary || "" });
}

function renderBreadcrumbs(items) {
  const categories = [...new Set(items.map(it =>
    SOURCE_CATEGORIES[it.source?.toLowerCase()] || "Other"
  ))];

  breadcrumbs.innerHTML = "";
  categories.forEach(cat => {
    const btn = document.createElement("button");
    btn.textContent = cat;
    btn.className = cat === activeSource ? "active" : "";
    btn.onclick = () => {
      activeSource = (cat === activeSource) ? null : cat;
      renderResults({
        originalQuery: searchInput.value,
        summary: aiSummary.textContent
      });
    };
    breadcrumbs.appendChild(btn);
  });

  breadcrumbs.classList.remove("hidden");
}

function renderResults(data) {
  let items = CURRENT_RESULTS;

  if (activeSource) {
    items = items.filter(it =>
      (SOURCE_CATEGORIES[it.source?.toLowerCase()] || "Other") === activeSource
    );
  }

  const total = items.length;
  const start = (PAGE - 1) * PAGE_SIZE;
  const end = start + PAGE_SIZE;
  const pageItems = items.slice(start, end);

  resultsGrid.innerHTML = "";
  resultsInfo.textContent = `Showing ${items.length} results for "${data.originalQuery}"`;
  resultsInfo.classList.remove("hidden");

  aiSummary.textContent = data.summary ? cleanHTML(data.summary) : "No summary available.";
  aiSummary.classList.remove("hidden");
  aiSummary.classList.add("collapsed");
  aiSummary.onclick = () => {
    aiSummary.classList.toggle("collapsed");
    aiSummary.classList.toggle("expanded");
  };

  if (pageItems.length === 0) {
    resultsGrid.innerHTML = "<p>No results found.</p>";
    return;
  }

  pageItems.forEach(item => {
    const div = document.createElement("div");
    div.className = "card";

    let pdf = item.url?.toLowerCase().includes(".pdf");

    div.innerHTML = `
      ${pdf ? `<span class="pdf-badge">PDF</span>` : ""}
      <h3>${cleanHTML(item.title || "Untitled")}</h3>
      <p>${cleanHTML(item.snippet || item.description || "No description available")}</p>
      <div class="meta">
        <span>${SOURCE_CATEGORIES[item.source?.toLowerCase()] || "Other"}</span>
        <a class="link-btn" href="${item.url}" target="_blank">Open</a>
      </div>
    `;

    resultsGrid.appendChild(div);
  });

  pagination.classList.remove("hidden");

  prevBtn.disabled = PAGE === 1;
  nextBtn.disabled = end >= total;

  prevBtn.onclick = () => {
    PAGE--;
    renderResults({ originalQuery: data.originalQuery, summary: data.summary });
  };

  nextBtn.onclick = () => {
    PAGE++;
    renderResults({ originalQuery: data.originalQuery, summary: data.summary });
  };

  renderBreadcrumbs(CURRENT_RESULTS);
}

/* ------- SEARCH BUTTON EVENT ------- */
searchBtn.onclick = async () => {
  const query = searchInput.value.trim();
  if (!query) return;

  showSkeleton();

  try {
    const res = await fetch(`${API_BASE}/api/search?q=${encodeURIComponent(query)}&pdfOnly=${pdfOnly.checked}`);
    const data = await res.json();

    CURRENT_RESULTS = data.results || [];
    PAGE = 1;

    saveState(query, data);

    renderResults({ originalQuery: query, summary: data.summary });

  } catch (err) {
    console.error(err);
    resultsGrid.innerHTML = "<p>Error loading results.</p>";
  }
};

window.onload = loadLastState;

</script>

</body>
</html>